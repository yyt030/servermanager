{% extends "bootstrap/base.html" %}
{% set active_page = active_page|default('index') -%}

{% block html_attribs %} lang="zh-CN" {% endblock %}
{% block title %}Server Manager{% endblock %}
{% block head %}
    {{ super() }}
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="renderer" content="webkit">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <!-- Custom styles for this template -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/admin.css') }}">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="{{ url_for('static', filename='js/html5shiv.js') }}"></script>
      <script src="{{ url_for('static', filename='js/respond.min.js')}}"></script>
    <![endif]-->
{% endblock %}
{% block navbar %}
    {% include 'include/_nav_header.html' %}
    {% include 'include/_nav_lefter.html' %}
{% endblock %}
{% block content %}
    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 container">
        <h1></h1>
        {% for message in get_flashed_messages() %}
            <div class="alert alert-warning">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                {{ message }}
            </div>
        {% endfor %}
        <div class="table-responsive">
            {% block content_header %}{% endblock %}
            {% block content_table %}{% endblock %}
            {% block content_form %}{% endblock %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/actions.js') }}" type="text/javascript"></script>
    <script language="javascript">
        var modelActions = new AdminModelActions("至少选择一条记录.", {"delete": "确定删除?"});
    </script>
    <script language="javascript">
        (function ($) {
            $("#user_add").click(function () {
                var x = document.getElementById('userstable').insertRow(0);
                var h1 = x.insertCell(0)
                var h2 = x.insertCell(1)
                var h3 = x.insertCell(2)
                h1.innerHTML = "<input class='id' type='hidden' value='#' /><div class='form-group'><label class='control-label' for='username'>用户名</label> <input class='form-control' id='username' name='username' type='text'></div>"
                h2.innerHTML = "<div class='form-group'><label class='control-label' for='password'>密码</label> <input class='form-control' id='password' name='password' type='password'> </div>"
                h3.innerHTML = "<button type='button' class='btn btn-success' onclick='addline(this)'>保存</button> <button type='button' class='btn btn-warning' onclick='deleteline(this)'>删除</button>"
                $(".form-control").keyup(function () {
                $(this).css("background-color","#ee9c72");
                })
            })

            $(".form-control").keyup(function () {
                $(this).css("background-color","#ee9c72");
            })
            $("#searchlist").hide()

            $("#searchBox").keyup(function () {

                var val = $("#searchBox").val();
                if (val.length > 0) {
                    $.ajax({
                        type: 'get',
                        url: '/dysearch',
                        data: {
                            'ip': val
                        },
                        success: function (data) {

                            var ipstrarr = new Array()
                            ipstrarr = data.split(",")
                            try {
                                var tipHtml = ""
                                for (i = 0; i < ipstrarr.length - 1; i++) {
                                    var width = parseInt($("#searchBox").width());
                                    tipHtml += "<input readonly='readonly' class='item' type='text' value=" + ipstrarr[i] + ">"
                                }

                                $("#searchlist").html(tipHtml).width(width)
                                $("#searchlist").show()
                                $("#searchlist input").click(function () {

                                    $("#searchlist").hide();
                                    $("#searchBox").val($(this).val());
                                });

                            } catch (e) {
                                {#                                alert(e.message)#}
                            }
                        },
                        error: function (err) {
                            {#                            alert(err.message)#}
                        }
                    })
                }
                else {
                    $("#searchlist").hide();
                }
            })
            $('[data-role=tooltip]').tooltip({
                html: true,
                placement: 'bottom'
            });

        })(jQuery);
    </script>
    <script>

        function addline(btn) {
            try {
                username = btn.parentNode.parentNode.cells[0].getElementsByTagName("INPUT")[1].value;
                userpasswd = btn.parentNode.parentNode.cells[1].getElementsByTagName("INPUT")[0].value;
                $.ajax({
                    type: 'post',
                    url: '{{ url_for("s.adduser") }}',
                    data: {
                        'username':username,
                        'userpasswd':userpasswd,
                        'serverid':$("#serverid").val()
                    },
                    success: function(){
                        var inputusr=btn.parentNode.parentNode.cells[0].getElementsByTagName("INPUT")[1]
                        var inputpad=btn.parentNode.parentNode.cells[1].getElementsByTagName("INPUT")[0]
                        inputusr.style.background="#ffffff"
                        inputpad.style.background="#ffffff"
                    }
                })
            }catch(e){
                alert(e.message)
            }

        }

        function deleteline(btn) {
            var id = username = btn.parentNode.parentNode.cells[0].getElementsByTagName("INPUT")[0].value;
            $.ajax({
                type: 'post',
                url: '{{ url_for("s.deleteuser") }}',
                data: {
                    'id':id
                },
                success: function (data) {

                },
                error: function (err) {
                }
            })
            var table = btn.parentNode.parentNode.parentNode.deleteRow(btn.parentNode.parentNode)

        }
        function openTerm(ip, username, password) {
            var mapForm = document.createElement("form");
            mapForm.target = "Map";
            mapForm.method = "POST";
            mapForm.id = 'postdata'
            mapForm.action = "http://{{ webssh_addr }}";

            var ipInput = document.createElement("input");
            ipInput.type = "hidden"
            ipInput.name = "ip"
            ipInput.value = ip

            var usernameInput = document.createElement("input");
            usernameInput.type = "hidden"
            usernameInput.name = "username"
            usernameInput.value = username

            var passwordInput = document.createElement("input");
            passwordInput.type = "hidden"
            passwordInput.name = "password"
            passwordInput.value = password


            mapForm.appendChild(ipInput);
            mapForm.appendChild(usernameInput)
            mapForm.appendChild(passwordInput)

            document.body.appendChild(mapForm);

            map = window.open("", "Map", "resizable=yes,toolbar=no,location=no,status=no,scrollbars=no,menubar=no,width=760,height=480");
            if (map) {
                mapForm.submit();
            } else {
                alert('You must allow popups for this map to work.');
            }
            return false;
        }
    </script>
{% endblock %}